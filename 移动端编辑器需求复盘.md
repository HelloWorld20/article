---
title: 移动端编辑器需求复盘
date: 2021-12-20 13:43
tags: 
    - [总结]
---

# 前言

这个项目又一次刷新我进公司做的项目的难度。这个是我们公司核心项目[编辑器](https://editor.test.rabbitpre.com/?contentType=poster&width=1080&height=1920)的移动端复刻版。是公司的核心项目。而且迭代相当长时间，代码质量很高，非常值得学习。这次需要我负责实现一个h5版本，是个非常有价值的机会。

关于这个项目的标签：`移动端`、`低代码`、`高性能`、`新项目`，听起来就挺有意思。 而且这个项目是之前完全没接开发过的，而且算上我5个前端、两个后端，需要我带领着完成。这样就更有挑战性了。

# 正文

这个项目大概是通过url传入模板id或者作品id。读取作品数据后，在h5中更新数据后保存。需要实现的大功能点有：

1. 撤销与反撤销
2. 利用作品数据生成图片（海报）
3. 小程序webview交互（目前是在小程序中访问的）
4. 多个可编辑的组件（图片、文字、svg、组合、员工名片）
5. 组件可以缩放、拖拽位置、删除与内容修改。

项目大约分为三个大模块：

1. 工具栏：可以做一些操作
2. 舞台：展示与操作组件的区域，即最终成品（海报）的可见即所得的可操作区域。
3. 设置面板：对组件进行设置的操作区域

## 1. 定义数据结构

因为是PC版编辑器的H5版，所以数据是需要一模一样的。这个没有太多需要思考的内容。不过倒是可以学到一些东西。

1. 复杂的项目往往需要一个良好的数据结构。

目前PC编辑器已经经过了长期的迭代，组件数据结构、页面数据结构已经有成熟的Typescript声明可以使用。而且声明文件已经独立发包，多个项目中引用。可以极大的限制各个项目的数据出错。

2. 复杂的项目需要清晰的数据流

此项目也是如此，所有组件数据都存储在redux中，舞台上的所有渲染内容都直接或间接来自store，然后设置面板、舞台拖拽组件都直接修改redux中的数据，而不是直接修改组件。从而形成单项数据流。

虽然一开始会觉得，可能会卡或者延迟（经过这一层传递）。但实际完成后，并没有出现担心的卡顿。然后这样的数据流很清晰、调试方便（利用redux-devtools改历史即可反映到视图）。所以基本可以确定是最佳方案。

这也就叫做`中介模式`？

3. 本地数据需要经过本地转义。

PC编辑器也用了我在全员名片设置里用到的方法。api => store => api的方式。接口数据虽然需要符合规范。但最好是，经过一个方法（flattern与structure、全员名片的api2form与form2api）方法转义。好处是可以百分百的转换成为适合mvvm的数据结构，也方便调试。产转换数据需要的计算，相对其带来的好处。其实微不足道。

### 关于组件设计的一个优化

目前是每个组件都有一个类，每个类都有个create方法可以创建组件数据。类里定义了多个静态方法来辅助处理组件数据。

其实不太明白，直接通过new方法来创建组件数据，然后定义一些通用方法，处理组件岂不妙哉？

```javascript
// 现有方式
const cmp = CmpModelClass.create();

// 如果要清除子组件
if(CmpModelClass.isContainer(cmp)) {
	cmp.cmps.forEach(id => {
		const child = store.cmps.byId[id];
		child.gid = '';
	})
	
	cmp.cmps = [];
}

```


```javascript
// 理想的方法
const cmp = new ImageModelClass();

// 如果要清除子组件
if(cmp.isContainer()) {
	cmp.clearChild();
}
```

但碍于时间限制，并没有优化。

## 2. 撤销与反撤销

这功能是我做的这项目里最复杂的功能，没有之一。

PC版这个功能本身就有bug，所以就趁机重写了逻辑。

1. 

### 连续update判断是否要加入历史

1. drag与resize组件时

需要存储touchStart与touchEnd时的快照。
touchStart快照用于撤销功能，拿到改变前的状态，然后还原快照
touchEnd快照用于反撤销功能，拿到改变后的状态，然后还原快照

3. 拖拽更改字体颜色与大小时

## immer

## getZoomValue尺寸转换

## 容器组件

## 数据的单向流动

## chrome dev-tools的性能分析

## postcss的px2rem插件

## errorBoundary

## 重新熟悉redux

## react-router实现的页面缓存

# 其他

## 没能很好的控制进度

## 生成海报略过html2canvas




